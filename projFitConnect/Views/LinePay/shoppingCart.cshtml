@{
    var memberId = ViewBag.memberId;
}
<input type="hidden" id="memberId" value="@memberId" />

<div class="fw-bolder fs-5"><i class="bi bi-cart4 mx-1"></i><span>購物車</span></div>
<!-- 商品畫面 -->
<div class="container">
    <table class="mx-auto table table-hover mb-1 mt-5">
        <thead>
            <tr class="shadow">
                <th>
                    <input class="form-check-input" type="checkbox" value="" id="allChecked" checked="" />
                    <label class="form-check-label" for="allChecked">
                        全選
                    </label>
                </th>
                <th scope="col">課程名稱</th>
                <th scope="col">教練</th>
                <th scope="col">售價</th>
            </tr>
        </thead>
        <tbody id="tbody"></tbody>
    </table>

    <div class="form-label form-control shadow" id="sumDiv"></div>
    <div class="row my-5">
        <div class="col-6 col-md-3">
            <form asp-action="Pay" method="post">
                <input type="number" id="formSum" name="sum" value="" hidden />
                <button type="submit" class="btn btn-success col-6 col-md-3 form-control" id="btnCheckOut">前往結帳</button>
            </form>
        </div>
        <div class="col-6 col-md-3">
            <button class="btn btn-danger col-6 col-md-3 form-control" onclick="goBack()">取消</button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const tbody = document.getElementById('tbody');
        const sumDiv = document.getElementById('sumDiv');
        const allChecked = document.getElementById('allChecked');
        const formSum = document.getElementById('formSum');
        const memberId = document.getElementById('memberId').value;
        let sum = 0;

        (async () => {
            const response = await fetch(`https://localhost:7199/api/Member/${memberId}`);
            const data = await response.json();
            data.reserveDetailDtos = data.reserveDetailDtos.filter(item => !item.paymentStatus);
            console.log(data.reserveDetailDtos);
            let innerHTML = "";

            data.reserveDetailDtos.forEach(item => {
                sum += item.courseFee;
                innerHTML += `<tr class="shadow">
                                  <td class="align-content-center"><input class="form-check-input" type="checkbox" value="${item.courseFee}" id="" checked=""/></td>
                                  <td class="align-content-center">${item.class}</td>
                                  <td class="align-content-center">${item.coach}</td>
                                  <td class="align-content-center">NT$${item.courseFee}</td>
                              </tr>`
            });
            tbody.innerHTML = innerHTML;
            sumDiv.innerHTML = `總金額:${sum}`;
            formSum.value = sum;

            const formCheckInput = document.querySelectorAll('.form-check-input');
            allChecked.addEventListener('click', () => {
                sum = 0;
                if (!allChecked.checked) {
                    formCheckInput.forEach(item => {
                        item.checked = false;
                    });
                } else {
                    formCheckInput.forEach(item => {
                        sum += Number(item.value);
                        item.checked = true;
                    });
                }
                sumDiv.innerHTML = `總金額:${sum}`;
                formSum.value = sum;
            });
            formCheckInput.forEach(item => {
                item.addEventListener('click', (event) => {
                    if (event.target.id == "allChecked")
                        return;
                    allChecked.checked = false;
                    sum = 0;
                    formCheckInput.forEach(item => {
                        if (item.checked) {
                            sum += Number(item.value);
                        }
                    });
                    sumDiv.innerHTML = `總金額:${sum}`;
                    formSum.value = sum;
                });
            });
        })();

        function goBack() {
            window.history.back();
        }
        
    </script>
}